# -*- coding: utf-8 -*-
"""Untitled6.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1ybeQNy4xuLxHFxfxWw2-YNF3SdwXhL-R
"""

import streamlit as st
import pandas as pd
import numpy as np
import joblib

# 1. Load Model
@st.cache_resource
def load_model():
    return joblib.load('lightgbm_model.pkl')

model = load_model()
# Mengambil urutan 65 kolom asli dari model secara otomatis
model_features = model.feature_name_

# 2. UI Layout sesuai capture gambar
st.set_page_config(page_title="Neurathink : Rain Prediction in Australia", layout="wide")
st.title("Rain Tomorrow Prediction")

# Ekstrak daftar kategori langsung dari model agar tidak ada yang terlewat
def get_categories(prefix):
    return sorted([col.replace(prefix, '') for col in model_features if col.startswith(prefix)])

locations = get_categories('Location_')
wind_gusts = get_categories('WindGustDir_')
wind_9am = get_categories('WindDir9am_')
wind_3pm = get_categories('WindDir3pm_')

with st.form("input_form"):
    col1, col2 = st.columns(2)
    with col1:
        loc = st.selectbox("Location", locations)
        h9 = st.number_input("Humidity 9am", 0.0, 100.0, 60.0)
        h3 = st.number_input("Humidity 3pm", 0.0, 100.0, 50.0)
        p9 = st.number_input("Pressure 9am", 900.0, 1100.0, 1015.0)
        rf = st.number_input("Rainfall Today (mm)", 0.0, 500.0, 0.0)
    with col2:
        wg = st.selectbox("Wind Gust Direction", wind_gusts)
        w9 = st.selectbox("Wind Direction 9am", wind_9am)
        w3 = st.selectbox("Wind Direction 3pm", wind_3pm)
        w_diff = st.number_input("Wind Speed Difference", value=5.0)
        t_range = st.number_input("Temp Range", value=10.0)

    rt = st.radio("Rain Today", ["No", "Yes"], horizontal=True)
    submitted = st.form_submit_button("Predict Rain Tomorrow")

if submitted:
    # Buat baris berisi 0 untuk semua 65 fitur
    input_df = pd.DataFrame(0, index=[0], columns=model_features)

    # Isi fitur numerik & log transform
    input_df['Humidity3pm'] = h3
    input_df['Humidity9am'] = h9
    input_df['Pressure9am'] = p9
    input_df['wind_diff'] = w_diff
    input_df['TempRange'] = t_range
    input_df['Rainfall_log'] = np.log1p(rf)
    input_df['RainToday_Yes'] = 1 if rt == "Yes" else 0

    # Isi fitur kategorikal (One-Hot)
    for prefix, val in [('Location_', loc), ('WindGustDir_', wg), ('WindDir9am_', w9), ('WindDir3pm_', w3)]:
        col = f"{prefix}{val}"
        if col in input_df.columns:
            input_df[col] = 1

    # Prediksi
    prediction = model.predict(input_df)[0]
    prob = model.predict_proba(input_df)[0]

    st.divider()
    if prediction == 1:
        st.error(f"### HASIL: BESOK HUJAN (YES) - Probabilitas: {prob[1]:.2%}")
    else:
        st.success(f"### HASIL: BESOK TIDAK HUJAN (NO) - Probabilitas: {prob[0]:.2%}")