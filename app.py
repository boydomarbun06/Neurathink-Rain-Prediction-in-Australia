# -*- coding: utf-8 -*-
"""App.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1jFfG1H826HPd7pbdXBlCbt3b-8UGai8o
"""

import streamlit as st
import pandas as pd
import numpy as np
import joblib
from sklearn.preprocessing import LabelEncoder

# 1. KONFIGURASI HALAMAN
st.set_page_config(page_title="Neurathink: Australian Rain Forecaster", layout="wide")
st.subheader("Predicting tomorrow's rainfall using Advanced Machine Learning")
st.markdown("---") # Garis pemisah horizontal

# 2. LOAD MODEL & ENCODER
# Pastikan Anda mem-pickle LabelEncoder saat training agar mapping-nya konsisten
@st.cache_resource
def load_assets():
    model = joblib.load('optimal_threshold.pkl') # Sesuaikan nama file model Anda
    return model

model = load_assets()

# Data unik dari dataset untuk selectbox (Berdasarkan analisis df_tmp)
LOCATIONS = [
    'Albury', 'BadgerysCreek', 'Cobar', 'CoffsHarbour', 'Moree', 'Newcastle',
    'NorahHead', 'NorfolkIsland', 'Penrith', 'Richmond', 'Sydney', 'SydneyAirport',
    'WaggaWagga', 'Williamtown', 'Wollongong', 'Canberra', 'Tuggeranong',
    'MountGinini', 'Ballarat', 'Bendigo', 'Sale', 'MelbourneAirport',
    'Melbourne', 'Mildura', 'Nhil', 'Portland', 'Watsonia', 'Dartmoor',
    'Brisbane', 'Cairns', 'GoldCoast', 'Townsville', 'Adelaide', 'MountGambier',
    'Nuriootpa', 'Woomera', 'Albany', 'Witchcliffe', 'PearceRAAF', 'PerthAirport',
    'Perth', 'SalmonGums', 'Walpole', 'Hobart', 'Launceston', 'AliceSprings',
    'Darwin', 'Katherine', 'Uluru'
]

DIRECTIONS = ['W', 'WNW', 'WSW', 'NE', 'NNW', 'N', 'NNE', 'SW', 'ENE', 'SSE',
              'S', 'NW', 'SE', 'ESE', 'E', 'SSW']

def main():
    st.title("üåßÔ∏è Rain Tomorrow Prediction")
    st.markdown("---")

    # Membagi input menjadi dua kolom
    col1, col2 = st.columns(2)

    with col1:
        st.subheader("üìç Informasi Lokasi & Angin")
        location = st.selectbox("Lokasi", sorted(LOCATIONS))
        wind_gust_dir = st.selectbox("Arah Hembusan Angin Terkuat (WindGustDir)", DIRECTIONS)
        wind_dir_9am = st.selectbox("Arah Angin Jam 9 Pagi", DIRECTIONS)
        wind_dir_3pm = st.selectbox("Arah Angin Jam 3 Sore", DIRECTIONS)
        rain_today = st.radio("Apakah Hari Ini Hujan? (RainToday)", ['No', 'Yes'])

    with col2:
        st.subheader("üìä Parameter Atmosfer")
        humidity_9am = st.slider("Kelembapan 9 Pagi (%)", 0, 100, 50)
        humidity_3pm = st.slider("Kelembapan 3 Sore (%)", 0, 100, 50)
        pressure_9am = st.number_input("Tekanan Udara 9 Pagi (hPa)", value=1015.0, step=0.1)

        st.info("Fitur Kalkulasi Otomatis (Engineering)")
        rainfall = st.number_input("Curah Hujan Hari Ini (Rainfall dalam mm)", min_value=0.0, value=0.0)
        t_min = st.number_input("Suhu Minimum (¬∞C)", value=15.0)
        t_max = st.number_input("Suhu Maksimum (¬∞C)", value=25.0)
        w_speed_9am = st.number_input("Kecepatan Angin 9 Pagi", value=10.0)
        w_speed_3pm = st.number_input("Kecepatan Angin 3 Sore", value=15.0)

    # 3. PREPROCESSING INPUT
    # Perhitungan fitur turunan sesuai dengan df_tmp Anda
    rainfall_log = np.log1p(rainfall)
    temp_range = t_max - t_min
    wind_diff = w_speed_3pm - w_speed_9am

    # Dataframe untuk prediksi
    input_dict = {
        'Location': location,
        'WindGustDir': wind_gust_dir,
        'WindDir9am': wind_dir_9am,
        'WindDir3pm': wind_dir_3pm,
        'Humidity9am': humidity_9am,
        'Humidity3pm': humidity_3pm,
        'Pressure9am': pressure_9am,
        'RainToday': rain_today,
        'Rainfall_log': rainfall_log,
        'TempRange': temp_range,
        'wind_diff': wind_diff
    }

    df_input = pd.DataFrame([input_dict])

    # PROSES ENCODING (Manual Mapping/Label Encoding)
    # Catatan: Idealnya gunakan LabelEncoder yang di-save saat training
    # Di sini saya sertakan simulasi encoding sederhana
    cat_cols = ['Location', 'WindGustDir', 'WindDir9am', 'WindDir3pm', 'RainToday']
    for col in cat_cols:
        le = LabelEncoder()
        # Dalam implementasi nyata, le.classes_ harus berasal dari training data
        df_input[col] = le.fit_transform(df_input[col])

    # 4. PREDIKSI
    st.markdown("---")
    if st.button("Analisis Kemungkinan Hujan Besok"):
        try:
            prediction = model.predict(df_input)
            probability = model.predict_proba(df_input)[0][1]

            if prediction[0] == 1 or prediction[0] == 'Yes':
                st.error(f"### ‚õàÔ∏è Prediksi: BESOK HUJAN")
                st.write(f"Probabilitas: {probability:.2%}")
            else:
                st.success(f"### ‚òÄÔ∏è Prediksi: BESOK CERAH / TIDAK HUJAN")
                st.write(f"Probabilitas Hujan: {probability:.2%}")

        except Exception as e:
            st.error(f"Terjadi kesalahan saat prediksi: {e}")
            st.info("Pastikan urutan kolom pada model sesuai dengan dataframe input.")

if __name__ == "__main__":
    main()