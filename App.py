# -*- coding: utf-8 -*-
"""Untitled6.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1ybeQNy4xuLxHFxfxWw2-YNF3SdwXhL-R
"""

import streamlit as st
import pandas as pd
import numpy as np
import joblib
import xgboost as xgb
from sklearn.preprocessing import LabelEncoder

# --- KONFIGURASI HALAMAN ---
st.set_page_config(page_title="Neurathink - Rain Prediction", layout="wide")

# --- FUNGSI LOAD MODEL (Pencegahan Error 'float64') ---
@st.cache_resource
def load_prediction_model():
    # Menggunakan cache agar model tidak dimuat berulang kali atau tertimpa
    try:
        # Skenario 1: Jika Anda menggunakan pipeline utuh (Disarankan)
        model_object = joblib.load('optimal_threshold')
        return model_object
    except:
        # Skenario 2: Jika model dan preprocessor terpisah (Fallback)
        # Kami asumsikan optimal_threshold berisi objek model ML yang valid
        st.error("Gagal memuat model. Pastikan file 'optimal_threshold' tersedia.")
        return None

# Inisialisasi model ke variabel global yang tidak akan tertimpa
MODEL_AI = load_prediction_model()

def main():
    # --- UI: JUDUL & SUBJUDUL ---
    st.markdown("<h1 style='text-align: center; color: #1E88E5;'>Rain Prediction App in Australia</h1>", unsafe_allow_html=True)
    st.markdown("<h4 style='text-align: center; color: #555;'>Advanced Forecasting by Neurathink</h4>", unsafe_allow_html=True)
    st.markdown("---")

    # --- SIDEBAR: INFO KELOMPOK ---
    st.sidebar.header("Project Info")
    st.sidebar.write("**Team: Neurathink**")


    # --- INPUT FITUR (Sesuai df_tmp di gambar) ---
    col1, col2 = st.columns(2)

    with col1:
        st.subheader("üìç Weather Station & Wind")
        location = st.selectbox("Location", ['Sydney', 'Melbourne', 'Brisbane', 'Perth', 'Adelaide', 'Cairns', 'Darwin'])
        wind_gust_dir = st.selectbox("Wind Gust Direction", ['W', 'WNW', 'WSW', 'NE', 'NNW', 'N', 'S', 'E'])
        wind_dir_9am = st.selectbox("Wind Direction 9am", ['W', 'N', 'S', 'E', 'SE', 'NW'])
        wind_dir_3pm = st.selectbox("Wind Direction 3pm", ['W', 'N', 'S', 'E', 'SE', 'NW'])
        rain_today = st.selectbox("Did it rain today? (RainToday)", ['No', 'Yes'])

    with col2:
        st.subheader("üìä Atmospheric Metrics")
        humidity_9am = st.slider("Humidity at 9am (%)", 0, 100, 50)
        humidity_3pm = st.slider("Humidity at 3pm (%)", 0, 100, 50)
        pressure_9am = st.number_input("Pressure at 9am (hPa)", value=1015.0)

        st.write("**Automatic Calculations:**")
        rainfall_raw = st.number_input("Rainfall Today (mm)", min_value=0.0, value=0.0)
        temp_min = st.number_input("Min Temp (¬∞C)", value=15.0)
        temp_max = st.number_input("Max Temp (¬∞C)", value=25.0)
        w_speed_9am = st.number_input("Wind Speed 9am", value=10.0)
        w_speed_3pm = st.number_input("Wind Speed 3pm", value=15.0)

    # --- PROSES DATA (Feature Engineering) ---
    # Hitung fitur tambahan sesuai notebook Anda
    rainfall_log = np.log1p(rainfall_raw)
    temp_range = temp_max - temp_min
    wind_diff = w_speed_3pm - w_speed_9am

    # Susun data ke DataFrame (Urutan harus sama dengan saat training)
    input_data = pd.DataFrame([{
        'Location': location,
        'WindGustDir': wind_gust_dir,
        'WindDir9am': wind_dir_9am,
        'WindDir3pm': wind_dir_3pm,
        'Humidity9am': humidity_9am,
        'Humidity3pm': humidity_3pm,
        'Pressure9am': pressure_9am,
        'RainToday': rain_today,
        'Rainfall_log': rainfall_log,
        'TempRange': temp_range,
        'wind_diff': wind_diff
    }])

    # --- PREDIKSI ---
    st.markdown("---")
    if st.button("Analyze Weather Probability"):
        if MODEL_AI is not None:
            try:
                # Pastikan memanggil .predict dari MODEL_AI (Bukan variabel yang tertimpa)
                prediction = MODEL_AI.predict(input_data)
                probability = MODEL_AI.predict_proba(input_data)

                # Menampilkan Hasil
                if prediction[0] == 1 or prediction[0] == 'Yes':
                    st.error(f"### ‚õàÔ∏è Prediksi: BESOK HUJAN")
                    st.metric("Confidence", f"{probability[0][1]:.2%}")
                else:
                    st.success(f"### ‚òÄÔ∏è Prediksi: BESOK TIDAK HUJAN")
                    st.metric("Confidence", f"{probability[0][0]:.2%}")

            except Exception as e:
                st.error(f"Error dalam prediksi: {e}")
                st.info("Kemungkinan besar ada ketidakcocokan antara fitur input dan model (Encoding issue).")
        else:
            st.warning("Model tidak tersedia.")

if __name__ == "__main__":
    main()